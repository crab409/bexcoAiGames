<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ìŠ¤ë¬´ê³ ê°œ</title>
    <link href="/css/style.css" rel="stylesheet">
    <link href="/css/game.css" rel="stylesheet">
  </head>
  <body>
    <div id="bg-overlay"></div>
    <div id="chat-app">
      <div class="chat-header">
        <div class="header-title">
          <span>ğŸ² ìŠ¤ë¬´ê³ ê°œ AI ê²Œì„</span>
          <button class="desc-toggle" aria-expanded="true" aria-controls="game-desc-content">ê²Œì„ ì„¤ëª… ë³´ê¸° â–¼</button>
        </div>
        <button id="mode-toggle">ğŸŒ™ ë‹¤í¬ ëª¨ë“œ</button>
      </div>
      <div class="game-desc show" id="game-desc-content">
        <span>AIê°€ ìƒê°í•œ ë‹¨ì–´ë¥¼ 20ë²ˆ ì´ë‚´ì— ì§ˆë¬¸ìœ¼ë¡œ ë§í˜€ë³´ì„¸ìš”!<br>
        ì˜ˆ) "ë™ë¬¼ì¸ê°€ìš”?", "ë¨¹ì„ ìˆ˜ ìˆë‚˜ìš”?" ë“±ìœ¼ë¡œ ì§ˆë¬¸í•´ë³´ì„¸ìš”.</span>
      </div>
      <div class="chat-container" id="chat-container"></div>
      <div class="input-area">
        <textarea id="message-input" placeholder="ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”..." rows="1"></textarea>
        <button id="send-button">â–¶</button>
      </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/socket.io@4.7.2/client-dist/socket.io.min.js"></script>
    <script>
      // ì•„ì½”ë””ì–¸(ì ‘ê¸°/í¼ì¹˜ê¸°) ê¸°ëŠ¥
      document.addEventListener('DOMContentLoaded', () => {
        const descToggle = document.querySelector('.desc-toggle');
        const descContent = document.getElementById('game-desc-content');
        descToggle.addEventListener('click', () => {
          const isOpen = descContent.classList.toggle('show');
          descToggle.setAttribute('aria-expanded', isOpen);
          descToggle.textContent = isOpen ? 'ê²Œì„ ì„¤ëª… ì ‘ê¸° â–²' : 'ê²Œì„ ì„¤ëª… ë³´ê¸° â–¼';
        });
      });

      const start = window.performance.now(); // ì¸¡ì • ì‹œì‘ 
      const socket = io();
      let keyword = "<%= key %>";
      let room;
      let answer;
      let metaData;
      let cnt = 0;

      // ìœ ì €ê°€ í˜ì´ì§€ì— ì ‘ì†í•˜ë©´ ë°©ì— ì°¸ì—¬
      socket.emit("joinRoom", {
        keyword: "<%= key %>",
      });

      // ë°©ì— ì°¸ì—¬ ëœ í›„, ì„œë²„ë¡œë¶€í„° ê²Œì„ì„ ì§„í–‰í•˜ê¸° ìœ„í•œ ë°ì´í„°ë¥¼ ë°›ìŒ
      socket.on("gameSetUp", (data) => {
        answer = data.answer;
        metaData = data.metaData;
        room = data.room;
      })



      // ë©”ì„¸ì§€ ì „ì†¡ì‹œ 
      document.querySelector("#send-button").addEventListener("click", function() {
        let inp = document.querySelector("#message-input").value;
        const chatContainer = document.querySelector("#chat-container");


        // ìƒˆë¡œìš´ ë©”ì‹œì§€ ì¶”ê°€
        chatContainer.insertAdjacentHTML("beforeend",
          `<div class="chat-box mine"><span>${inp}</span></div>`
        );


        let data = {
          answer: answer,
          metaData: metaData,
          room: room,
          keyword: "<%= key %>",
          cnt: cnt++,
          msg: inp,
        };
        socket.emit("userMsg", data);


        // ì±„íŒ… ì»¨í…Œì´ë„ˆ ìŠ¤í¬ë¡¤ì„ ì•„ë˜ë¡œ ê³ ì •
        chatContainer.scrollTop = chatContainer.scrollHeight;


        // ìŠ¤ë¬´ê³ ê°œ ì‹¤íŒ¨ì‹œ
        if (cnt >= 20) {
          let end = window.performance.now();
          let time = end - start;
          location.replace(`/gameEnd/${time}/${cnt}/0`);
        }
      });



      socket.on("serverMsg", (data) => {
        const chatContainer = document.querySelector("#chat-container");

        // ì„œë²„ ë©”ì‹œì§€ ì¶”ê°€
        chatContainer.insertAdjacentHTML("beforeend",
          `<div class="chat-box"><span>${data}</span></div>`
        );

        // ì±„íŒ… ì»¨í…Œì´ë„ˆ ìŠ¤í¬ë¡¤ì„ ì•„ë˜ë¡œ ê³ ì •
        chatContainer.scrollTop = chatContainer.scrollHeight;
      });

      socket.on("answer", (data) => {
        if (data == 1) {
          let end = window.performance.now();
          let time = (end - start) / 1000;
          location.replace(`/gameEnd/${time}/${cnt}/1`);
        }
      });
    </script>
    <script src="/javaScript/Script.js"></script>
  </body>
</html>